name: Process New Orders and Send Email

on:
  push:
    paths:
      - 'orders/pending/**'
  workflow_dispatch:

jobs:
  process-order:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install jq
      run: sudo apt-get install -y jq

    - name: Find and process orders
      id: process-orders
      run: |
        mkdir -p orders/processed
        mkdir -p orders/failed
        
        # Find pending orders
        ORDER_FILES=$(find orders/pending -name "*.json" -type f 2>/dev/null || true)
        
        if [ -z "$ORDER_FILES" ]; then
          echo "No pending orders found"
          echo "processed_count=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        PROCESSED_COUNT=0
        
        for order_file in $ORDER_FILES; do
          echo "ðŸ” Processing: $order_file"
          
          ORDER_DATA=$(cat "$order_file")
          ORDER_ID=$(echo "$ORDER_DATA" | jq -r '.id')
          CUSTOMER_NAME=$(echo "$ORDER_DATA" | jq -r '.customer.name')
          CUSTOMER_PHONE=$(echo "$ORDER_DATA" | jq -r '.customer.phone')
          CUSTOMER_ADDRESS=$(echo "$ORDER_DATA" | jq -r '.customer.address')
          TOTAL_AMOUNT=$(echo "$ORDER_DATA" | jq -r '.summary.totalAmount')
          
          # Generate email content
          EMAIL_SUBJECT="ðŸ›‹ï¸ New Furniture Order - $CUSTOMER_NAME"
          EMAIL_BODY="ðŸ›‹ï¸ NEW FURNITURE ORDER ðŸ›‹ï¸

          Order ID: $ORDER_ID
          Order Date: $(date)

          ðŸ‘¤ CUSTOMER DETAILS:
          â€¢ Name: $CUSTOMER_NAME
          â€¢ Address: $CUSTOMER_ADDRESS
          â€¢ Pincode: $(echo "$ORDER_DATA" | jq -r '.customer.pincode')
          â€¢ Phone: $CUSTOMER_PHONE
          â€¢ GST: $(echo "$ORDER_DATA" | jq -r '.customer.gstNo // "Not Provided"')

          ðŸ›’ ORDER ITEMS:"
                    
                    # Add order items
                    ITEM_COUNT=$(echo "$ORDER_DATA" | jq -r '.items | length')
                    for i in $(seq 0 $(($ITEM_COUNT - 1))); do
                      ITEM_NAME=$(echo "$ORDER_DATA" | jq -r ".items[$i].name")
                      ITEM_MATERIAL=$(echo "$ORDER_DATA" | jq -r ".items[$i].material")
                      ITEM_QTY=$(echo "$ORDER_DATA" | jq -r ".items[$i].quantity")
                      ITEM_TOTAL=$(echo "$ORDER_DATA" | jq -r ".items[$i].totalPrice")
                      EMAIL_BODY="$EMAIL_BODY
          â€¢ $ITEM_NAME ($ITEM_MATERIAL) - Qty: $ITEM_QTY - â‚¹$ITEM_TOTAL"
                    done
                    
                    EMAIL_BODY="$EMAIL_BODY

          ðŸ’° ORDER SUMMARY:
          â€¢ Total Items: $(echo "$ORDER_DATA" | jq -r '.summary.totalItems')
          â€¢ Total Amount: â‚¹$TOTAL_AMOUNT

          ---
          SK Steel And Furniture - Automated Order System"
                    
                    echo "ðŸ“§ Sending email for order: $ORDER_ID"
                    
                    # Send email using FormSubmit (Free service)
                    curl -X POST "https://formsubmit.co/ajax/shazadkhan143614361436@gmail.com" \
                      -H "Content-Type: application/json" \
                      -d "{
                        \"name\": \"$CUSTOMER_NAME\",
                        \"subject\": \"$EMAIL_SUBJECT\", 
                        \"message\": \"$EMAIL_BODY\"
                      }" && echo "âœ… Email sent via FormSubmit" || echo "âŒ FormSubmit failed"
                    
                    # Move to processed
                    mv "$order_file" "orders/processed/$(basename "$order_file")"
                    ((PROCESSED_COUNT++))
                    
                    echo "âœ… Order $ORDER_ID processed successfully"
                  done
                  
                  echo "processed_count=$PROCESSED_COUNT" >> $GITHUB_OUTPUT

    - name: Commit processed orders
      if: steps.process-orders.outputs.processed_count > 0
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add orders/
        git commit -m "Process ${{ steps.process-orders.outputs.processed_count }} orders [skip ci]" || echo "No changes to commit"
        git push