name: Process New Orders and Send Email

on:
  push:
    paths:
      - 'orders/pending/**'
  workflow_dispatch:

jobs:
  process-order:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Install jq for JSON parsing
      run: sudo apt-get install -y jq

    - name: Find and process orders
      id: process-orders
      run: |
        # Create directories
        mkdir -p orders/processed
        
        # Find pending orders
        ORDER_FILES=$(find orders/pending -name "*.json" -type f 2>/dev/null || true)
        
        if [ -z "$ORDER_FILES" ]; then
          echo "No pending orders found"
          echo "processed_count=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        PROCESSED_COUNT=0
        
        for order_file in $ORDER_FILES; do
          echo "ðŸ” Processing: $order_file"
          
          # Read order data
          ORDER_DATA=$(cat "$order_file")
          ORDER_ID=$(echo "$ORDER_DATA" | jq -r '.id')
          CUSTOMER_NAME=$(echo "$ORDER_DATA" | jq -r '.customer.name')
          CUSTOMER_PHONE=$(echo "$ORDER_DATA" | jq -r '.customer.phone')
          TOTAL_AMOUNT=$(echo "$ORDER_DATA" | jq -r '.summary.totalAmount')
          
          echo "Order: $ORDER_ID, Customer: $CUSTOMER_NAME, Total: â‚¹$TOTAL_AMOUNT"
          
          # Generate email content
          EMAIL_SUBJECT="ðŸ›‹ï¸ New Furniture Order - $CUSTOMER_NAME"
          
          # Build email body step by step
          EMAIL_BODY="ðŸ›‹ï¸ NEW FURNITURE ORDER - SK Steel And Furniture

          ORDER ID: $ORDER_ID
          ORDER DATE: $(date)

          CUSTOMER DETAILS:
          â€¢ Name: $CUSTOMER_NAME
          â€¢ Address: $(echo "$ORDER_DATA" | jq -r '.customer.address')
          â€¢ Pincode: $(echo "$ORDER_DATA" | jq -r '.customer.pincode')
          â€¢ Phone: $CUSTOMER_PHONE
          â€¢ GST: $(echo "$ORDER_DATA" | jq -r '.customer.gstNo // "Not Provided"')

          ORDER ITEMS:"

                    # Add each order item
                    ITEM_COUNT=$(echo "$ORDER_DATA" | jq -r '.items | length')
                    for i in $(seq 0 $(($ITEM_COUNT - 1))); do
                      ITEM_NAME=$(echo "$ORDER_DATA" | jq -r ".items[$i].name")
                      ITEM_MATERIAL=$(echo "$ORDER_DATA" | jq -r ".items[$i].material")
                      ITEM_QTY=$(echo "$ORDER_DATA" | jq -r ".items[$i].quantity")
                      ITEM_TOTAL=$(echo "$ORDER_DATA" | jq -r ".items[$i].totalPrice")
                      EMAIL_BODY="$EMAIL_BODY
          â€¢ $ITEM_NAME ($ITEM_MATERIAL) - Qty: $ITEM_QTY - â‚¹$ITEM_TOTAL"
                    done

                    # Add summary
                    EMAIL_BODY="$EMAIL_BODY

          ORDER SUMMARY:
          â€¢ Total Items: $(echo "$ORDER_DATA" | jq -r '.summary.totalItems')
          â€¢ Total Amount: â‚¹$TOTAL_AMOUNT

          ---
          Automated Order System
          SK Steel And Furniture"

                    echo "ðŸ“§ Attempting to send email for order: $ORDER_ID"
                    
                    # Send email using FormSubmit (FREE - no setup needed)
                    FORM_SUBMIT_RESPONSE=$(curl -s -X POST "https://formsubmit.co/ajax/shazadkhan143614361436@gmail.com" \
                      -H "Content-Type: application/json" \
                      -d "{
                        \"name\": \"$CUSTOMER_NAME\",
                        \"subject\": \"$EMAIL_SUBJECT\", 
                        \"message\": \"$EMAIL_BODY\"
                      }")
                    
                    if echo "$FORM_SUBMIT_RESPONSE" | grep -q "success"; then
                      echo "âœ… Email sent successfully via FormSubmit"
                    else
                      echo "âŒ FormSubmit failed: $FORM_SUBMIT_RESPONSE"
                    fi
                    
                    # Move to processed regardless
                    mv "$order_file" "orders/processed/$(basename "$order_file")"
                    ((PROCESSED_COUNT++))
                    
                    echo "âœ… Order $ORDER_ID processed successfully"
                  done
                  
                  echo "processed_count=$PROCESSED_COUNT" >> $GITHUB_OUTPUT

    - name: Commit processed orders
      if: steps.process-orders.outputs.processed_count > 0
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add orders/
        git commit -m "Process ${{ steps.process-orders.outputs.processed_count }} orders [skip ci]" || echo "No changes to commit"
        git push